/****************************************************************************
*   Generated by ACUITY #ACUITY_VERSION#
*   Match ovxlib #OVXLIB_VERSION#
*
*   Neural Network application project entry file
****************************************************************************/
/*-------------------------------------------
                Includes
-------------------------------------------*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#ifdef __linux__
#include <sys/time.h>
#endif

#define _BASETSD_H

#include "vsi_nn_pub.h"

#include "vnn_global.h"
#include "vnn_#NETWORK_NAME_LOWER#.h"

/*-------------------------------------------
        Macros and Variables
-------------------------------------------*/

/*-------------------------------------------
                  Functions
-------------------------------------------*/
static void vnn_ReleaseNeuralNetwork
    (
    vsi_nn_graph_t *graph
    )
{
    vnn_Release#NETWORK_NAME#( graph, TRUE );
}

static vsi_status vnn_ProcessGraph
    (
    vsi_nn_graph_t *graph,
    const char *vdata_file_path,
    const char *vdes_file_path
    )
{
    vsi_status status = VSI_SUCCESS;

    uint32_t i,stream_size;
    vsi_nn_node_t *node;
    vsi_nn_tensor_t *tensor;

    uint8_t *stream = NULL;
    FILE *fp1 = NULL, *fp2 = NULL;
    long offset,ret;
    size_t sz;
    #define _DESCRIPTION_TMPBUF_SZ  (128)
    char description_temp_buf[_DESCRIPTION_TMPBUF_SZ] = {0};
    int32_t des_count = 0;

    /* Verify graph */
    printf("Verify ...\n");
    status = vsi_nn_VerifyGraph( graph );
    TEST_CHECK_STATUS( status, final );
    printf("Verify success...\n");

    offset = 0;
    fp1 = fopen( vdata_file_path, "wb+" );
    TEST_CHECK_PTR(fp1, final);

    fp2 = fopen( vdes_file_path, "w+" );
    TEST_CHECK_PTR(fp2, final);

    for(i=0; i<graph->node_num; i++)
    {
        node = graph->nodes[i];
        if((node->op == VSI_NN_OP_CONV_RELU_POOL
            || node->op == VSI_NN_OP_CONV_RELU
            || node->op == VSI_NN_OP_FCL_RELU)
            && vsi_nn_GetTensor(graph, node->input.tensors[1])->wb)
        {
            tensor = vsi_nn_GetTensor(graph, node->input.tensors[1]);
            stream_size = 0;
            stream = (uint8_t *)vxWeightsBiasesParameterToStream(
                graph->ctx->c,
                tensor->wb, &stream_size,
                FALSE
                );

            ret = fseek(fp1, offset, SEEK_SET);
            if(0 == ret)
            {
                sz = fwrite(stream, 1, stream_size, fp1);
                if(sz < stream_size)
                {
                    status = VSI_FAILURE;
                    break;
                }
                if(stream)
                {
                    vsi_nn_Free(stream);
                    stream = NULL;
                }

                memset(description_temp_buf, 0, sizeof(description_temp_buf));
                des_count = snprintf(description_temp_buf, _DESCRIPTION_TMPBUF_SZ,
                    "%u %u %d %ld %u\n", node->uid, 1, -1, offset, stream_size);
                sz = fwrite( description_temp_buf, des_count, 1, fp2 );
                if(sz < 1)
                {
                    status = VSI_FAILURE;
                    break;
                }
                offset += stream_size;
            }
            else
            {
                status = VSI_FAILURE;
                break;
            }
        }
    }

final:
    fclose(fp1);
    fclose(fp2);
    if(stream)
    {
        vsi_nn_Free(stream);
        stream = NULL;
    }

    return status;
}

static vsi_nn_graph_t *vnn_CreateNeuralNetwork
    (
    const char *data_file_name
    )
{
    vsi_nn_graph_t *graph = NULL;

    graph = vnn_Create#NETWORK_NAME#(data_file_name, NULL);
    TEST_CHECK_PTR(graph, final);

    /* Show the node and tensor */
    vsi_nn_PrintGraph(graph);

final:
    return graph;
}

/*-------------------------------------------
                  Main Functions
-------------------------------------------*/
int main
    (
    int argc,
    char **argv
    )
{
    vsi_status status;
    vsi_nn_graph_t *graph;
    const char *data_name = NULL;
    const char *target_name = NULL;
    const char *vdata_file_path = NULL;
    const char *vdes_file_path = NULL;

    status = VSI_FAILURE;


    if(argc == 5)
    {
        data_name = (const char *)argv[1];
        target_name = (const char *)argv[2];
        vdata_file_path = (const char *)argv[3];
        vdes_file_path = (const char *)argv[4];
    }
    else
    {
        printf("Usage: %s i_data_file_name i_target_name o_vdata_file_path o_vdes_file_path\n", argv[0]);
        return -1;
    }

    extern vsi_status VX_API_CALL vivSetVSimulatorTarget(const char *);
    vivSetVSimulatorTarget(target_name);

    /* Create the neural network */
    graph = vnn_CreateNeuralNetwork( data_name );
    TEST_CHECK_PTR(graph, final);

    /* Verify and Process graph */
    status = vnn_ProcessGraph( graph, vdata_file_path, vdes_file_path );
    TEST_CHECK_STATUS( status, final );

    if(VSI_SUCCESS == status)
        printf(".vdata .vdes files generate success.\n");
    else
        printf(".vdata .vdes files generate failure.\n");

final:
    vnn_ReleaseNeuralNetwork( graph );
    return status;
}

